<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <!-- Mobile-friendly + notch safe -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
    <title>Christmas Menu</title>

    <style>
        html,
        body {
            margin: 0;
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
        }

        body {
            overscroll-behavior: none;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* ===== LOADING SCREEN ===== */
        #loading-screen {
            position: absolute;
            inset: 0;
            z-index: 9999;

            background-color: #000;
            background-image: url('assets/backgrounds/loading.png');
            background-position: center center;
            background-repeat: no-repeat;
            background-size: cover;

            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 60px;

            transition: opacity 0.5s ease-out;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ===== MENU STAGE ===== */
        #stage {
            position: absolute;
            inset: 0;
            background: #000;
            overflow: hidden;
        }

        /* IMPORTANT: no scale transform. We set artboard width/height in JS to fit viewport */
        #artboard {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transform-origin: center center;
        }

        /* IMPORTANT: never stretch the image with mismatched %s */
        #menuBg {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            user-select: none;
            -webkit-user-drag: none;
        }

        .btn {
            position: absolute;
            width: 21.4516%;
            height: auto;
            cursor: pointer;
            user-select: none;
            -webkit-user-drag: none;
            touch-action: manipulation;
        }

        /* ===== VIDEO LAYER ===== */
        #videoLayer {
            position: absolute;
            inset: 0;
            display: none;
            background: #000;
            z-index: 5;
            touch-action: manipulation;
        }

        #v {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            pointer-events: none;
        }

        /* Audio UI */
        #song {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            z-index: 20;
            display: none;

            bottom: calc(20px + env(safe-area-inset-bottom));

            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;

            touch-action: auto;
        }

        #song.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* ===== UI BUTTONS ===== */
        .ui-btn {
            position: fixed;
            z-index: 30;
            padding: 10px 14px;
            border: 2px solid rgba(255, 255, 255, .85);
            background: rgba(0, 0, 0, .55);
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            display: none;
            transition: opacity 0.3s, background 0.2s;
            line-height: 1;
            touch-action: manipulation;
            font: 700 16px system-ui, sans-serif;
        }

        .ui-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .ui-btn.show {
            display: block;
        }

        /* Top-left cluster: Main Menu + Exit */
        #topLeftControls {
            position: fixed;
            top: calc(14px + env(safe-area-inset-top));
            left: calc(14px + env(safe-area-inset-left));
            z-index: 30;
            display: none;
            gap: 10px;
        }

        #topLeftControls.show {
            display: flex;
        }

        /* Override fixed positioning for buttons inside the cluster */
        #topLeftControls .ui-btn {
            position: relative;
            top: auto;
            left: auto;
            display: block;
            /* controlled by cluster */
        }

        #fsBtn {
            bottom: calc(20px + env(safe-area-inset-bottom));
            right: calc(20px + env(safe-area-inset-right));
            font-size: 24px;
            padding: 5px 10px 10px 10px;
        }

        /* Mobile: suppress fullscreen button entirely */
        .is-mobile #fsBtn {
            display: none !important;
        }
    </style>
</head>

<body>

    <!-- LOADING SCREEN -->
    <div id="loading-screen">
        <div class="spinner"></div>
    </div>

    <!-- MENU -->
    <div id="stage">
        <div id="artboard">
            <img id="menuBg" src="assets/backgrounds/menu.png" alt="Menu" draggable="false" />

            <!-- Buttons -->
            <img class="btn" data-i="1" src="assets/buttons/button1.png" style="left:42.1505%; top:12.6582%;"
                draggable="false" />
            <img class="btn" data-i="2" src="assets/buttons/button2.png" style="left:42.1505%; top:25.9007%;"
                draggable="false" />
            <img class="btn" data-i="3" src="assets/buttons/button3.png" style="left:42.1505%; top:39.0458%;"
                draggable="false" />
            <img class="btn" data-i="4" src="assets/buttons/button4.png" style="left:42.1505%; top:52.2882%;"
                draggable="false" />
            <img class="btn" data-i="5" src="assets/buttons/button5.png" style="left:42.1505%; top:65.5307%;"
                draggable="false" />
            <img class="btn" data-i="6" src="assets/buttons/button6.png" style="left:42.1505%; top:78.6758%;"
                draggable="false" />
            <img class="btn" data-i="7" src="assets/buttons/button7.png" style="left:42.1505%; top:91.9182%;"
                draggable="false" />
            <!-- Exit button (top-left) -->
            <img class="btn" data-i="8" src="assets/buttons/button8.png" style="left:2.0%; top:2.0%; width:10.5%;"
                draggable="false" />
        </div>
    </div>

    <!-- VIDEO LAYER -->
    <div id="videoLayer">
        <div id="topLeftControls" aria-label="Top left controls">
            <button id="backBtn" class="ui-btn" type="button" aria-label="Main menu">← Main Menu</button>
            <button id="exitBtn" class="ui-btn" type="button" aria-label="Exit to itch page">Exit</button>
        </div>

        <button id="fsBtn" class="ui-btn" type="button" aria-label="Toggle Full Screen">⛶</button>

        <video id="v" playsinline muted preload="auto">
            <source src="production_final.mp4" type="video/mp4">
        </video>

        <audio id="song" controls preload="auto"></audio>
    </div>

    <script>
        /* ====== LOADING SCREEN ====== */
        window.addEventListener("load", () => {
            const loader = document.getElementById("loading-screen");
            loader.style.opacity = "0";
            setTimeout(() => { loader.style.display = "none"; }, 500);
        });

        /* ====== CONFIG ====== */
        const songForButton = {
            1: "assets/songs/Christmas Skating Rink.mp3",
            2: "assets/songs/Four Cozy Christmas Stops.mp3",
            3: "assets/songs/Magic in a Busy Mind.mp3",
            4: "assets/songs/Cozy Crowds at Christmas.mp3",
            5: "assets/songs/Christmas Countdown.mp3",
            6: "assets/songs/Count-It-Quick Christmas.mp3",
        };

        const playlist = [
            songForButton[1], songForButton[2], songForButton[3],
            songForButton[4], songForButton[5], songForButton[6],
        ];

        // Preload hover images
        // Preload hover images
        for (let i = 1; i <= 8; i++) (new Image()).src = `assets/buttons/buttonmo${i}.png`;


        /* ====== ELEMENTS ====== */
        const menuStage = document.getElementById("stage");
        const artboard = document.getElementById("artboard");
        const menuBg = document.getElementById("menuBg");

        const videoLayer = document.getElementById("videoLayer");
        const v = document.getElementById("v");
        const song = document.getElementById("song");

        const topLeftControls = document.getElementById("topLeftControls");
        const backBtn = document.getElementById("backBtn");
        const exitBtn = document.getElementById("exitBtn");
        const fsBtn = document.getElementById("fsBtn");

        // iOS inline hints
        v.setAttribute("playsinline", "");
        v.setAttribute("webkit-playsinline", "");

        /* ====== MOBILE DETECTION (for fullscreen suppression) ====== */
        const IS_MOBILE =
            (window.matchMedia && window.matchMedia("(pointer: coarse)").matches) ||
            /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

        document.documentElement.classList.toggle("is-mobile", IS_MOBILE);

        let mode = "menu";
        let playlistIndex = 0;

        /* ====== MENU FIT (NO TRANSFORM SCALING) ======
           We set artboard width/height to scaled pixels, so mobile doesn't "zoom out" the whole page.
        */
        let DESIGN_W = 1920;
        let DESIGN_H = 1080;

        const stageEl = document.getElementById("stage");

        function fitArtboard() {
            const r = stageEl.getBoundingClientRect(); // <-- real rendered box on itch/mobile
            const s = Math.min(r.width / DESIGN_W, r.height / DESIGN_H);

            artboard.style.width = (DESIGN_W * s) + "px";
            artboard.style.height = (DESIGN_H * s) + "px";
        }

        function syncDesignToMenuImage() {
            if (!menuBg.naturalWidth || !menuBg.naturalHeight) return;
            DESIGN_W = menuBg.naturalWidth;
            DESIGN_H = menuBg.naturalHeight;
            fitArtboard();
        }

        menuBg.addEventListener("load", () => {
            syncDesignToMenuImage();
        });
        if (menuBg.complete) syncDesignToMenuImage();

        window.addEventListener("resize", fitArtboard);
        if (window.visualViewport) {
            window.visualViewport.addEventListener("resize", fitArtboard);
            window.visualViewport.addEventListener("scroll", fitArtboard);
        }
        new ResizeObserver(fitArtboard).observe(stageEl);
        fitArtboard();

        /* ====== AUDIO/VIDEO COUPLING (RESTORED: INSTANT, NO CHASING) ====== */
        function snapVideoToAudio() {
            const t = song.currentTime || 0;
            try { v.currentTime = t; } catch (e) { }
        }

        song.addEventListener("play", () => {
            snapVideoToAudio();                // snap first
            v.play().catch(() => { });         // then play
            showUI(true);
        });

        song.addEventListener("pause", () => {
            v.pause();
            showUI(false);
        });

        // Only when you RELEASE the scrubber (instant + no stalls)
        song.addEventListener("seeked", () => {
            const wasPlaying = !song.paused;
            snapVideoToAudio();
            if (wasPlaying) v.play().catch(() => { });
        });

        /* ====== FULLSCREEN (with iOS fallback) ====== */
        async function toggleFullscreen() {
            // Mobile: suppressed
            if (IS_MOBILE) return;

            try {
                if (document.fullscreenElement) {
                    return document.exitFullscreen?.();
                }
                if (document.documentElement.requestFullscreen) {
                    return document.documentElement.requestFullscreen();
                }
                if (v.webkitEnterFullscreen) {
                    return v.webkitEnterFullscreen();
                }
            } catch (e) {
                console.log(e);
            }
        }

        function togglePlayPause() {
            if (song.paused) song.play().catch(() => { });
            else song.pause();
        }

        /* ====== EXIT (back to itch page) ====== */
        function exitToItch() {
            const ref = document.referrer;

            // Best case: embedded in itch -> referrer is the itch game page
            if (ref) {
                try { window.top.location.href = ref; return; } catch (e) { }
                window.location.href = ref;
                return;
            }

            // Fallbacks (direct-open cases)
            try { window.close(); } catch (e) { }
            history.back();
        }

        /* ====== UI BUTTONS ====== */
        fsBtn.addEventListener("click", (e) => { e.stopPropagation(); toggleFullscreen(); });
        backBtn.addEventListener("click", (e) => { e.stopPropagation(); showMenu(); });
        exitBtn.addEventListener("click", (e) => { e.stopPropagation(); exitToItch(); });

        /* ====== TAP / DOUBLE-TAP (mobile reliable) ====== */
        function isUiTarget(e) { return e.target.closest("#topLeftControls, #fsBtn, #song"); }

        let lastTap = 0;
        videoLayer.addEventListener("pointerup", (e) => {
            if (isUiTarget(e)) return;

            // Mobile: no fullscreen gesture; just toggle play/pause
            if (IS_MOBILE) {
                togglePlayPause();
                return;
            }

            const now = performance.now();
            if (now - lastTap < 300) {
                lastTap = 0;
                toggleFullscreen();
            } else {
                lastTap = now;
                setTimeout(() => {
                    if (lastTap && performance.now() - lastTap >= 290) {
                        lastTap = 0;
                        togglePlayPause();
                    }
                }, 300);
            }
        });

        /* ====== UI VISIBILITY ====== */
        let hideTimer = null;

        function showUI(temp = true) {
            topLeftControls.classList.add("show");
            song.classList.add("show");

            if (!IS_MOBILE) fsBtn.classList.add("show");

            if (!temp || song.paused) return;

            clearTimeout(hideTimer);
            hideTimer = setTimeout(() => {
                if (!song.paused) {
                    topLeftControls.classList.remove("show");
                    if (!IS_MOBILE) fsBtn.classList.remove("show");
                    song.classList.remove("show");
                }
            }, 2000);
        }

        function hideUI() {
            clearTimeout(hideTimer);
            topLeftControls.classList.remove("show");
            fsBtn.classList.remove("show");
            song.classList.remove("show");
        }

        window.addEventListener("mousemove", () => showUI(true));
        window.addEventListener("touchstart", () => showUI(true), { passive: true });

        /* ====== NAVIGATION ====== */
        function stopAll() {
            song.pause();
            song.currentTime = 0;
            song.classList.remove("show");
            song.style.display = "none";

            v.pause();
            hideUI();
        }


        function showMenu() {
            mode = "menu";
            stopAll();
            videoLayer.style.display = "none";
            menuStage.style.display = "block";

            if (document.fullscreenElement && document.exitFullscreen) {
                document.exitFullscreen().catch(() => { });
            }
        }

        function showPlayer() {
            menuStage.style.display = "none";
            videoLayer.style.display = "block";
            song.style.display = "block";
            showUI(false);
        }

        function playContent(path) {
            v.loop = true;
            v.muted = true;

            // Don’t start the video here (this is what caused “catch up”)
            try { v.pause(); v.currentTime = 0; } catch (e) { }

            song.src = encodeURI(path);
            song.currentTime = 0;
            song.load();

            const sp = song.play();
            if (sp && typeof sp.catch === "function") sp.catch(() => { });
        }

        function startSingle(i) {
            mode = "single";
            showPlayer();
            playContent(songForButton[i]);
        }

        function startPlaylistLoop() {
            mode = "playlist";
            playlistIndex = 0;
            showPlayer();
            playContent(playlist[playlistIndex]);
        }

        song.addEventListener("ended", () => {
            if (mode === "single") {
                showMenu();
            } else if (mode === "playlist") {
                playlistIndex = (playlistIndex + 1) % playlist.length;
                playContent(playlist[playlistIndex]);
            }
        });

        /* ====== MENU BUTTONS ====== */
        document.querySelectorAll(".btn").forEach(btn => {
            const i = parseInt(btn.dataset.i, 10);
            const normal = `assets/buttons/button${i}.png`;
            const hover = `assets/buttons/buttonmo${i}.png`;

            btn.addEventListener("mouseenter", () => btn.src = hover);
            btn.addEventListener("mouseleave", () => btn.src = normal);
            btn.addEventListener("pointerdown", () => btn.src = hover);
            btn.addEventListener("pointerup", () => btn.src = normal);
            btn.addEventListener("pointercancel", () => btn.src = normal);

            btn.addEventListener("click", () => {
                stopAll();
                if (i === 8) exitToItch();
                else if (i === 7) startPlaylistLoop();
                else startSingle(i);
            });
        });

        window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") showMenu();
        });
    </script>
</body>

</html>